%Programed by : Nguyen Minh Hoang
%Date:26/09/2022

%% declare the parameter
g =9.81; % gravity acceleration
m =0.046; % wheel weight
R =0.0335; % Wheel radius
M =0.945;  % body weight
W =0.17; % Body width
D =0.1; % Body depth
H =0.121;% Body Height
L =0.121/2;% distance

J_psi  = M*L^2/3; % Body inertia moment
Jw = m*R^2/2;  %Wheel inertia moment
J_phi = M*(W^2+D^2)/12; % Body yaw inertia moment
Jm = 0.041185; % Dc motor inertia moment

n =30 ; %gear ratio
Rm=8.6123;      %dien tro dong co DC
Kb=0.22244;   %he so emf cua dong co
Kt=3.0896;   %momemt xoan cua dong co DC
fm = 0.0022; % friction cof between body and DC motor.
fw = 0; % friction cof between wheel and floor



clc; clear all; close all;
syms m M R Jw n Jm L n anp bet fw g W J_phi vl vr J_psi x1 x2 x3 x4 x5 x6 x7 x8 x9 Kt Kb Rm fm tau1 tau2 tau3;

% anp = n*Kt/Rm;
% bet = n*Kt*Kb/Rm +fm;

f1 = ((2*m + M)*R^2 + 2*Jw + 2*n^2*Jm)*x3 + (M*L*R*cos(x4) - 2*n^2*Jm)*x6 - M*L*R*x5^2*sin(x4)-(anp*(vl+vr)-2*(bet+fw)*x2+2*bet*x5);
f2 = (M*L*R*cos(x4) - 2*n^2*Jm)*x3 + (M*L^2 + J_psi + 2*n^2*Jm)*x6 - (M*g*L*sin(x4) + M*L^2*x8^2*sin(x4)*cos(x4))-(-anp*(vl+vr)+2*bet*x2-2*bet*x5);
f3 = (0.5*m*W^2 + J_phi + 0.5*W^2*(Jw + n^2*Jm)/R^2 + M*L^2*sin(x4)^2)*x9 + 2*M*L^2*x5*x8*sin(x4)*cos(x4)-(W*anp*(vr-vl)/(2*R)-W^2*(bet+fw)*x8/(2*R^2));


[x3,x6,x9]=(solve(f1,f2,f3,x3,x6,x9))



%%
% h1 = (J_psi*anp*vl + J_psi*anp*vr - 2*J_psi*bet*x2 + 2*J_psi*bet*x5 - 2*J_psi*fw*x2 + L^2*M*anp*vl + L^2*M*anp*vr - 2*L^2*M*bet*x2 + 2*L^2*M*bet*x5 - 2*L^2*M*fw*x2 - 4*Jm*fw*n^2*x2 + L^3*M^2*R*x5^2*sin(x4) - 2*L*M*R*bet*x2*cos(x4) + 2*L*M*R*bet*x5*cos(x4) - L^3*M^2*R*x8^2*sin(2*x4)*cos(x4) - L^2*M^2*R*g*cos(x4)*sin(x4) + J_psi*L*M*R*x5^2*sin(x4) + 2*Jm*L*M*g*n^2*sin(x4) + 2*Jm*L^2*M*n^2*x8^2*sin(2*x4) + L*M*R*anp*vl*cos(x4) + L*M*R*anp*vr*cos(x4) + 2*Jm*L*M*R*n^2*x5^2*sin(x4))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
% h2 =-(2*Jw*anp*vl + 2*Jw*anp*vr - 4*Jw*bet*x2 + 4*Jw*bet*x5 + M*R^2*anp*vl + M*R^2*anp*vr - 2*M*R^2*bet*x2 + 2*M*R^2*bet*x5 + 2*R^2*anp*m*vl + 2*R^2*anp*m*vr + 4*Jm*fw*n^2*x2 - 4*R^2*bet*m*x2 + 4*R^2*bet*m*x5 - L*M^2*R^2*g*sin(x4) - 2*Jw*L*M*g*sin(x4) - 2*L*M*R*bet*x2*cos(x4) + 2*L*M*R*bet*x5*cos(x4) - 2*L*M*R*fw*x2*cos(x4) + L^2*M^2*R^2*x5^2*cos(x4)*sin(x4) - L^2*M^2*R^2*x8^2*cos(x4)*sin(x4) - 2*Jw*L^2*M*x8^2*cos(x4)*sin(x4) - 2*Jm*L*M*g*n^2*sin(x4) - 2*L*M*R^2*g*m*sin(x4) + L*M*R*anp*vl*cos(x4) + L*M*R*anp*vr*cos(x4) - 2*Jm*L^2*M*n^2*x8^2*cos(x4)*sin(x4) - 2*L^2*M*R^2*m*x8^2*cos(x4)*sin(x4) - 2*Jm*L*M*R*n^2*x5^2*sin(x4))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
% h3 = -(W^2*bet*x8 + W^2*fw*x8 + R*W*anp*vl - R*W*anp*vr + 4*L^2*M*R^2*x5*x8*cos(x4)*sin(x4))/(2*J_phi*R^2 + Jw*W^2 + Jm*W^2*n^2 + R^2*W^2*m + 2*L^2*M*R^2*sin(x4)^2);

h1=x3;
h2=x6;
h3=x9;


f1 = x2;
f2 = h1;
f3 = x5;
f4 = h2;
f5 = x8;
f6 = h3;

A =simplify(expand([diff(f1,x1),diff(f1,x2),diff(f1,x4),diff(f1,x5),diff(f1,x7),diff(f1,x8);
                    diff(f2,x1),diff(f2,x2),diff(f2,x4),diff(f2,x5),diff(f2,x7),diff(f2,x8);
                    diff(f3,x1),diff(f3,x2),diff(f3,x4),diff(f3,x5),diff(f3,x7),diff(f3,x8);
                    diff(f4,x1),diff(f4,x2),diff(f4,x4),diff(f4,x5),diff(f4,x7),diff(f4,x8);
                    diff(f5,x1),diff(f5,x2),diff(f5,x4),diff(f5,x5),diff(f5,x7),diff(f5,x8);
                    diff(f6,x1),diff(f6,x2),diff(f6,x4),diff(f6,x5),diff(f6,x7),diff(f6,x8)]));
B = simplify(expand([diff(f1,vl),diff(f1,vr);
                     diff(f2,vl),diff(f2,vr);
                     diff(f3,vl),diff(f3,vr);
                     diff(f4,vl),diff(f4,vr);
                     diff(f5,vl),diff(f5,vr);
                     diff(f6,vl),diff(f6,vr)]));


                 
                 
%linearization in zero point
clc; clear all; close all;
syms m M R Jw n Jm L n anp bet fw g W J_phi vl vr J_psi  Kt Kb Rm fm the_dot psi_dot;
the=0; the_dot=0; psi=0; psi_dot=0; phi=0; phi_dot=0; vl=0; vr=0;
x1=0;x2=0;x4=0;x5=0;x7=0;x8=0;

A1=...
[0,                                                                                                                                                                                                                                                                                                                      1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                    0, 0,                                                                                                                                                                                                                                                                                 0;
 0,          -(2*(J_psi*bet + J_psi*fw + L^2*M*bet + L^2*M*fw + 2*Jm*fw*n^2 + L*M*R*bet*cos(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -((L^4*M^4*R^3*g*cos(2*x4))/2 - (L^4*M^4*R^3*g)/2 + (L^5*M^4*R^3*x5^2*cos(x4))/4 - (3*L^5*M^4*R^3*x8^2*cos(x4))/8 - (L^5*M^4*R^3*x5^2*cos(3*x4))/4 + (7*L^5*M^4*R^3*x8^2*cos(3*x4))/16 - (L^5*M^4*R^3*x8^2*cos(5*x4))/16 - 2*Jw*L^5*M^3*R*x5^2*cos(x4) + (Jw*L^5*M^3*R*x8^2*cos(x4))/2 + (5*L^3*M^3*R^3*anp*vl*sin(x4))/4 + (5*L^3*M^3*R^3*anp*vr*sin(x4))/4 - (5*L^3*M^3*R^3*bet*x2*sin(x4))/2 + (5*L^3*M^3*R^3*bet*x5*sin(x4))/2 - 4*Jm^2*L^4*M^2*n^4*x8^2*cos(2*x4) + J_psi*L^2*M^3*R^3*g*cos(2*x4) - 4*Jm*L^4*M^3*R^2*n^2*x5^2 + 2*Jm*L^4*M^3*R^2*n^2*x8^2 - J_psi^2*L*M^2*R^3*x5^2*cos(x4) - (3*J_psi*L^3*M^3*R^3*x5^2*cos(x4))/4 + (J_psi*L^3*M^3*R^3*x8^2*cos(x4))/4 + (3*Jw*L^5*M^3*R*x8^2*cos(3*x4))/2 - 4*Jm^2*L^3*M^2*g*n^4*cos(x4) + 2*L^4*M^3*R^3*g*m*cos(2*x4) - 2*L^5*M^3*R^3*m*x5^2*cos(x4) + (L^5*M^3*R^3*m*x8^2*cos(x4))/2 + L^4*M^3*R^2*anp*vl*sin(2*x4) + (L^3*M^3*R^3*anp*vl*sin(3*x4))/4 + L^4*M^3*R^2*anp*vr*sin(2*x4) + (L^3*M^3*R^3*anp*vr*sin(3*x4))/4 - 2*L^4*M^3*R^2*bet*x2*sin(2*x4) - (L^3*M^3*R^3*bet*x2*sin(3*x4))/2 + 2*L^4*M^3*R^2*bet*x5*sin(2*x4) + (L^3*M^3*R^3*bet*x5*sin(3*x4))/2 - 2*L^4*M^3*R^2*fw*x2*sin(2*x4) - 8*Jm^2*L^2*M^2*R^2*n^4*x5^2 - (J_psi*L^3*M^3*R^3*x5^2*cos(3*x4))/4 + (3*J_psi*L^3*M^3*R^3*x8^2*cos(3*x4))/4 - 8*Jm^2*L^2*M^2*R*g*n^4 + (3*L^5*M^3*R^3*m*x8^2*cos(3*x4))/2 + 2*Jw*L^4*M^3*R*g*cos(2*x4) + J_psi*L*M^2*R^3*anp*vl*sin(x4) + J_psi*L*M^2*R^3*anp*vr*sin(x4) + 2*Jw*L^3*M^2*R*anp*vl*sin(x4) + 2*Jw*L^3*M^2*R*anp*vr*sin(x4) - 2*J_psi*L*M^2*R^3*bet*x2*sin(x4) + 2*J_psi*L*M^2*R^3*bet*x5*sin(x4) - 4*Jw*L^3*M^2*R*bet*x2*sin(x4) + 4*Jw*L^3*M^2*R*bet*x5*sin(x4) + 2*Jm*L^2*M^3*R^3*g*n^2*cos(2*x4) + (Jm*L^3*M^3*R^2*g*n^2*cos(3*x4))/2 - 4*J_psi*Jm^2*L^2*M*n^4*x8^2*cos(2*x4) - 4*Jm*Jw*L^4*M^2*n^2*x8^2*cos(2*x4) - 8*Jm^2*Jw*L^2*M*n^4*x8^2*cos(2*x4) + (3*J_psi*L^3*M^2*R^3*m*x8^2*cos(3*x4))/2 + (3*Jm*L^5*M^3*R*n^2*x8^2*cos(3*x4))/2 - (3*Jm*L^3*M^3*R^3*n^2*x5^2*cos(x4))/2 - 4*Jm^2*L*M^2*R^3*n^4*x5^2*cos(x4) - 4*Jm^2*L^3*M^2*R*n^4*x5^2*cos(x4) + (Jm*L^3*M^3*R^3*n^2*x8^2*cos(x4))/2 - 6*Jm^2*L^3*M^2*R*n^4*x8^2*cos(x4) + 2*J_psi*Jw*L^2*M^2*R*g*cos(2*x4) - 4*J_psi*Jw*L^3*M^2*R*x5^2*cos(x4) + (J_psi*Jw*L^3*M^2*R*x8^2*cos(x4))/2 - 4*Jm*Jw*L^3*M^2*g*n^2*cos(x4) - 2*J_psi^2*L*M*R^3*m*x5^2*cos(x4) - (Jm*L^3*M^3*R^3*n^2*x5^2*cos(3*x4))/2 + Jm*L^4*M^3*R^2*n^2*x8^2*cos(2*x4) + (3*Jm*L^3*M^3*R^3*n^2*x8^2*cos(3*x4))/2 - 2*Jm^2*L^3*M^2*R*n^4*x8^2*cos(3*x4) + Jm*L^4*M^3*R^2*n^2*x8^2*cos(4*x4) + 2*L^3*M^2*R^3*anp*m*vl*sin(x4) + 2*L^3*M^2*R^3*anp*m*vr*sin(x4) - 4*L^3*M^2*R^3*bet*m*x2*sin(x4) + 4*L^3*M^2*R^3*bet*m*x5*sin(x4) - 4*J_psi*Jm*L^2*M^2*R^2*n^2*x5^2 + (3*J_psi*Jw*L^3*M^2*R*x8^2*cos(3*x4))/2 + 2*J_psi*L^2*M^2*R^3*g*m*cos(2*x4) + 2*Jm*L^4*M^3*R*g*n^2*cos(2*x4) + (7*Jm*L^3*M^3*R^2*g*n^2*cos(x4))/2 - 4*Jm^2*L*M^2*R^2*g*n^4*cos(x4) - 4*J_psi*L^3*M^2*R^3*m*x5^2*cos(x4) + (J_psi*L^3*M^2*R^3*m*x8^2*cos(x4))/2 - 2*Jm*L^5*M^3*R*n^2*x5^2*cos(x4) + (Jm*L^5*M^3*R*n^2*x8^2*cos(x4))/2 + J_psi*L^2*M^2*R^2*anp*vl*sin(2*x4) + J_psi*L^2*M^2*R^2*anp*vr*sin(2*x4) - 2*J_psi*L^2*M^2*R^2*bet*x2*sin(2*x4) + 2*J_psi*L^2*M^2*R^2*bet*x5*sin(2*x4) - 2*J_psi*L^2*M^2*R^2*fw*x2*sin(2*x4) - 2*J_psi^2*Jw*L*M*R*x5^2*cos(x4) - 4*Jm^2*L^2*M^2*R^2*n^4*x8^2*cos(2*x4) - 4*J_psi*Jm^2*L*M*g*n^4*cos(x4) - 8*Jm^2*Jw*L*M*g*n^4*cos(x4) + 2*J_psi*Jm*L^2*M^2*R*g*n^2*cos(2*x4) + 4*Jm*Jw*L^2*M^2*R*g*n^2*cos(2*x4) - 4*J_psi*Jm*Jw*L^2*M*n^2*x8^2*cos(2*x4) - 4*J_psi*Jm*L*M^2*R^3*n^2*x5^2*cos(x4) - 4*J_psi*Jm*L^3*M^2*R*n^2*x5^2*cos(x4) + (J_psi*Jm*L^3*M^2*R*n^2*x8^2*cos(x4))/2 - 8*Jm*Jw*L^3*M^2*R*n^2*x5^2*cos(x4) + Jm*Jw*L^3*M^2*R*n^2*x8^2*cos(x4) + 2*J_psi*L*M*R^3*anp*m*vl*sin(x4) + 2*J_psi*L*M*R^3*anp*m*vr*sin(x4) - 4*J_psi*L*M*R^3*bet*m*x2*sin(x4) + 4*J_psi*L*M*R^3*bet*m*x5*sin(x4) - 4*Jm*L^3*M^2*R^2*g*m*n^2*cos(x4) - 8*Jm^2*L*M*R^3*m*n^4*x5^2*cos(x4) + (3*J_psi*Jm*L^3*M^2*R*n^2*x8^2*cos(3*x4))/2 + 3*Jm*Jw*L^3*M^2*R*n^2*x8^2*cos(3*x4) + 16*Jm^2*L*M*R*fw*n^4*x2*sin(x4) + 4*Jm*L^2*M^2*R^3*g*m*n^2*cos(2*x4) - 8*Jm*L^3*M^2*R^3*m*n^2*x5^2*cos(x4) + Jm*L^3*M^2*R^3*m*n^2*x8^2*cos(x4) + 2*J_psi*Jw*L*M*R*anp*vl*sin(x4) + 2*J_psi*Jw*L*M*R*anp*vr*sin(x4) - 4*J_psi*Jw*L*M*R*bet*x2*sin(x4) + 4*J_psi*Jw*L*M*R*bet*x5*sin(x4) - 4*Jm*L^2*M^2*R^2*fw*n^2*x2*sin(2*x4) - 2*J_psi*Jm*L*M^2*R^2*g*n^2*cos(x4) - 2*J_psi^2*Jm*L*M*R*n^2*x5^2*cos(x4) - 4*J_psi*Jm^2*L*M*R*n^4*x5^2*cos(x4) - 8*Jm^2*Jw*L*M*R*n^4*x5^2*cos(x4) - 8*Jm^2*L*M*R^2*g*m*n^4*cos(x4) - 2*J_psi*Jm*L^2*M^2*R^2*n^2*x8^2*cos(2*x4) + 2*Jm*L*M^2*R^3*anp*n^2*vl*sin(x4) - 2*Jm*L^3*M^2*R*anp*n^2*vl*sin(x4) + 2*Jm*L*M^2*R^3*anp*n^2*vr*sin(x4) - 2*Jm*L^3*M^2*R*anp*n^2*vr*sin(x4) - 4*Jm*L*M^2*R^3*bet*n^2*x2*sin(x4) + 4*Jm*L^3*M^2*R*bet*n^2*x2*sin(x4) + 4*Jm*L*M^2*R^3*bet*n^2*x5*sin(x4) - 4*Jm*L^3*M^2*R*bet*n^2*x5*sin(x4) - 4*J_psi*Jm*Jw*L*M*g*n^2*cos(x4) + 8*Jm*L^3*M^2*R*fw*n^2*x2*sin(x4) - 4*Jm*L^4*M^2*R^2*m*n^2*x8^2*cos(2*x4) - 8*Jm^2*L^2*M*R^2*m*n^4*x8^2*cos(2*x4) + 3*Jm*L^3*M^2*R^3*m*n^2*x8^2*cos(3*x4) - 8*J_psi*Jm*L*M*R^3*m*n^2*x5^2*cos(x4) - 2*J_psi*Jm*L*M*R*anp*n^2*vl*sin(x4) - 2*J_psi*Jm*L*M*R*anp*n^2*vr*sin(x4) + 4*Jm*Jw*L*M*R*anp*n^2*vl*sin(x4) + 4*Jm*Jw*L*M*R*anp*n^2*vr*sin(x4) + 4*J_psi*Jm*L*M*R*bet*n^2*x2*sin(x4) - 4*J_psi*Jm*L*M*R*bet*n^2*x5*sin(x4) - 8*Jm*Jw*L*M*R*bet*n^2*x2*sin(x4) + 8*Jm*Jw*L*M*R*bet*n^2*x5*sin(x4) + 8*J_psi*Jm*L*M*R*fw*n^2*x2*sin(x4) - 8*J_psi*Jm*Jw*L*M*R*n^2*x5^2*cos(x4) - 4*J_psi*Jm*L*M*R^2*g*m*n^2*cos(x4) - 4*J_psi*Jm*L^2*M*R^2*m*n^2*x8^2*cos(2*x4) + 4*Jm*L*M*R^3*anp*m*n^2*vl*sin(x4) + 4*Jm*L*M*R^3*anp*m*n^2*vr*sin(x4) - 8*Jm*L*M*R^3*bet*m*n^2*x2*sin(x4) + 8*Jm*L*M*R^3*bet*m*n^2*x5*sin(x4))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4))^2, (2*(J_psi*bet + L^2*M*bet + L^3*M^2*R*x5*sin(x4) + L*M*R*bet*cos(x4) + J_psi*L*M*R*x5*sin(x4) + 2*Jm*L*M*R*n^2*x5*sin(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)), 0,  (2*L^2*M*x8*cos(x4)*sin(x4)*(2*Jm*n^2 - L*M*R*cos(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
 0,                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                    1, 0,                                                                                                                                                                                                                                                                                 0;
 0, (2*(2*Jw*bet + M*R^2*bet - 2*Jm*fw*n^2 + 2*R^2*bet*m + L*M*R*bet*cos(x4) + L*M*R*fw*cos(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)), ((L^4*M^4*R^4*x5^2)/2 - (L^4*M^4*R^4*x8^2)/2 + (L^3*M^4*R^4*g*cos(3*x4))/4 + 4*Jw^2*L^4*M^2*x8^2*cos(2*x4) - (L^4*M^4*R^4*x5^2*cos(2*x4))/2 + (L^4*M^4*R^4*x8^2*cos(2*x4))/2 - Jw*L^4*M^3*R^2*x8^2 + 4*Jw^2*L^3*M^2*g*cos(x4) - (L^3*M^4*R^4*g*cos(x4))/4 - L^4*M^3*R^4*m*x8^2 + (3*L^3*M^3*R^4*g*m*cos(x4))/2 + (5*L^3*M^3*R^3*anp*vl*sin(x4))/4 + (5*L^3*M^3*R^3*anp*vr*sin(x4))/4 - (5*L^3*M^3*R^3*bet*x2*sin(x4))/2 + (5*L^3*M^3*R^3*bet*x5*sin(x4))/2 + 4*J_psi*Jw^2*L*M*g*cos(x4) - (5*L^3*M^3*R^3*fw*x2*sin(x4))/2 + 4*Jm^2*L^4*M^2*n^4*x8^2*cos(2*x4) + 4*L^4*M^2*R^4*m^2*x8^2*cos(2*x4) + (Jw*L^3*M^3*R^2*g*cos(3*x4))/2 - Jm*L^4*M^3*R^2*n^2*x8^2 + 4*J_psi*Jw^2*L^2*M*x8^2*cos(2*x4) + 4*Jm^2*L^3*M^2*g*n^4*cos(x4) + (L^3*M^3*R^4*g*m*cos(3*x4))/2 + 4*L^3*M^2*R^4*g*m^2*cos(x4) + L^2*M^3*R^4*anp*vl*sin(2*x4) + (L^3*M^3*R^3*anp*vl*sin(3*x4))/4 + L^2*M^3*R^4*anp*vr*sin(2*x4) + (L^3*M^3*R^3*anp*vr*sin(3*x4))/4 - 2*L^2*M^3*R^4*bet*x2*sin(2*x4) - (L^3*M^3*R^3*bet*x2*sin(3*x4))/2 + 2*L^2*M^3*R^4*bet*x5*sin(2*x4) + (L^3*M^3*R^3*bet*x5*sin(3*x4))/2 - (L^3*M^3*R^3*fw*x2*sin(3*x4))/2 + J_psi*L*M^3*R^4*g*cos(x4) + 8*Jm^2*L^2*M^2*R^2*n^4*x5^2 - J_psi*L^2*M^3*R^4*x5^2*cos(2*x4) + J_psi*L^2*M^3*R^4*x8^2*cos(2*x4) - 2*Jw*L^4*M^3*R^2*x5^2*cos(2*x4) + 3*Jw*L^4*M^3*R^2*x8^2*cos(2*x4) + 4*Jm*L^2*M^3*R^3*g*n^2 + 8*Jm^2*L^2*M^2*R*g*n^4 - 2*L^4*M^3*R^4*m*x5^2*cos(2*x4) + 3*L^4*M^3*R^4*m*x8^2*cos(2*x4) + (3*Jw*L^3*M^3*R^2*g*cos(x4))/2 + 4*J_psi*L*M*R^4*g*m^2*cos(x4) + 4*J_psi*L*M^2*R^4*g*m*cos(x4) - 2*J_psi*Jw*L^2*M^2*R^2*x5^2*cos(2*x4) + 4*J_psi*Jw*L^2*M^2*R^2*x8^2*cos(2*x4) + J_psi*L*M^2*R^3*anp*vl*sin(x4) + J_psi*L*M^2*R^3*anp*vr*sin(x4) + 2*Jw*L^3*M^2*R*anp*vl*sin(x4) + 2*Jw*L^3*M^2*R*anp*vr*sin(x4) - 2*J_psi*L*M^2*R^3*bet*x2*sin(x4) + 2*J_psi*L*M^2*R^3*bet*x5*sin(x4) - 4*Jw*L^3*M^2*R*bet*x2*sin(x4) + 4*Jw*L^3*M^2*R*bet*x5*sin(x4) - 2*J_psi*L*M^2*R^3*fw*x2*sin(x4) - 4*Jw*L^3*M^2*R*fw*x2*sin(x4) + (Jm*L^3*M^3*R^2*g*n^2*cos(3*x4))/2 + 4*J_psi*Jm^2*L^2*M*n^4*x8^2*cos(2*x4) + 8*Jm*Jw^2*L^2*M*n^2*x8^2*cos(2*x4) + 8*Jm*Jw*L^4*M^2*n^2*x8^2*cos(2*x4) + 8*Jm^2*Jw*L^2*M*n^4*x8^2*cos(2*x4) - 2*J_psi*L^2*M^2*R^4*m*x5^2*cos(2*x4) + 4*J_psi*L^2*M*R^4*m^2*x8^2*cos(2*x4) + 4*J_psi*L^2*M^2*R^4*m*x8^2*cos(2*x4) + 8*Jw*L^4*M^2*R^2*m*x8^2*cos(2*x4) - (7*Jm*L^3*M^3*R^3*n^2*x5^2*cos(x4))/2 + 4*Jm^2*L*M^2*R^3*n^4*x5^2*cos(x4) + 4*Jm^2*L^3*M^2*R*n^4*x5^2*cos(x4) + 3*Jm*L^3*M^3*R^3*n^2*x8^2*cos(x4) + 6*Jm^2*L^3*M^2*R*n^4*x8^2*cos(x4) + 8*Jm*L^2*M^2*R^3*g*m*n^2 + 8*Jm*Jw*L^3*M^2*g*n^2*cos(x4) + 8*Jw*L^3*M^2*R^2*g*m*cos(x4) + 2*Jm*L*M^3*R^4*g*n^2*cos(x4) - 2*Jm*L^2*M^3*R^4*n^2*x5^2*cos(2*x4) - 2*Jm*L^4*M^3*R^2*n^2*x5^2*cos(2*x4) - (Jm*L^3*M^3*R^3*n^2*x5^2*cos(3*x4))/2 + 2*Jm*L^2*M^3*R^4*n^2*x8^2*cos(2*x4) + 3*Jm*L^4*M^3*R^2*n^2*x8^2*cos(2*x4) + Jm*L^3*M^3*R^3*n^2*x8^2*cos(3*x4) + 2*Jm^2*L^3*M^2*R*n^4*x8^2*cos(3*x4) + 2*L^3*M^2*R^3*anp*m*vl*sin(x4) + 2*L^3*M^2*R^3*anp*m*vr*sin(x4) - 4*L^3*M^2*R^3*bet*m*x2*sin(x4) + 4*L^3*M^2*R^3*bet*m*x5*sin(x4) - 4*L^3*M^2*R^3*fw*m*x2*sin(x4) + (3*Jm*L^3*M^3*R^2*g*n^2*cos(x4))/2 + 4*Jm^2*L*M^2*R^2*g*n^4*cos(x4) + 8*Jm*Jw*L^2*M^2*R*g*n^2 + 2*Jw*L^2*M^2*R^2*anp*vl*sin(2*x4) + 2*Jw*L^2*M^2*R^2*anp*vr*sin(2*x4) - 4*Jw*L^2*M^2*R^2*bet*x2*sin(2*x4) + 4*Jw*L^2*M^2*R^2*bet*x5*sin(2*x4) + 4*J_psi*Jw*L*M^2*R^2*g*cos(x4) + 4*Jm^2*L^2*M^2*R^2*n^4*x8^2*cos(2*x4) + 2*L^2*M^2*R^4*anp*m*vl*sin(2*x4) + 2*L^2*M^2*R^4*anp*m*vr*sin(2*x4) - 4*L^2*M^2*R^4*bet*m*x2*sin(2*x4) + 4*L^2*M^2*R^4*bet*m*x5*sin(2*x4) + 4*J_psi*Jm^2*L*M*g*n^4*cos(x4) + 8*Jm*Jw^2*L*M*g*n^2*cos(x4) + 8*Jm^2*Jw*L*M*g*n^4*cos(x4) + 8*J_psi*Jm*Jw*L^2*M*n^2*x8^2*cos(2*x4) + 8*J_psi*Jw*L^2*M*R^2*m*x8^2*cos(2*x4) + 2*J_psi*Jm*L*M^2*R^3*n^2*x5^2*cos(x4) + 4*Jm*Jw*L^3*M^2*R*n^2*x5^2*cos(x4) + 6*Jm*Jw*L^3*M^2*R*n^2*x8^2*cos(x4) + 2*J_psi*L*M*R^3*anp*m*vl*sin(x4) + 2*J_psi*L*M*R^3*anp*m*vr*sin(x4) - 4*J_psi*L*M*R^3*bet*m*x2*sin(x4) + 4*J_psi*L*M*R^3*bet*m*x5*sin(x4) - 4*J_psi*L*M*R^3*fw*m*x2*sin(x4) + 8*Jm*L^3*M^2*R^2*g*m*n^2*cos(x4) + 8*Jm^2*L*M*R^3*m*n^4*x5^2*cos(x4) + 2*Jm*Jw*L^3*M^2*R*n^2*x8^2*cos(3*x4) - 16*Jm^2*L*M*R*fw*n^4*x2*sin(x4) + 4*Jm*L^3*M^2*R^3*m*n^2*x5^2*cos(x4) + 6*Jm*L^3*M^2*R^3*m*n^2*x8^2*cos(x4) + 2*J_psi*Jw*L*M*R*anp*vl*sin(x4) + 2*J_psi*Jw*L*M*R*anp*vr*sin(x4) - 4*J_psi*Jw*L*M*R*bet*x2*sin(x4) + 4*J_psi*Jw*L*M*R*bet*x5*sin(x4) - 4*J_psi*Jw*L*M*R*fw*x2*sin(x4) + 4*Jm*L^2*M^2*R^2*fw*n^2*x2*sin(2*x4) + 4*J_psi*Jm*L*M^2*R^2*g*n^2*cos(x4) + 8*Jm*Jw*L*M^2*R^2*g*n^2*cos(x4) + 4*J_psi*Jm^2*L*M*R*n^4*x5^2*cos(x4) + 8*Jm^2*Jw*L*M*R*n^4*x5^2*cos(x4) + 8*Jm*L*M*R^4*g*m^2*n^2*cos(x4) + 8*Jm*L*M^2*R^4*g*m*n^2*cos(x4) + 8*Jm^2*L*M*R^2*g*m*n^4*cos(x4) - 2*J_psi*Jm*L^2*M^2*R^2*n^2*x5^2*cos(2*x4) + 4*J_psi*Jm*L^2*M^2*R^2*n^2*x8^2*cos(2*x4) - 4*Jm*Jw*L^2*M^2*R^2*n^2*x5^2*cos(2*x4) + 8*Jm*Jw*L^2*M^2*R^2*n^2*x8^2*cos(2*x4) - 2*Jm*L*M^2*R^3*anp*n^2*vl*sin(x4) + 2*Jm*L^3*M^2*R*anp*n^2*vl*sin(x4) - 2*Jm*L*M^2*R^3*anp*n^2*vr*sin(x4) + 2*Jm*L^3*M^2*R*anp*n^2*vr*sin(x4) + 4*Jm*L*M^2*R^3*bet*n^2*x2*sin(x4) - 4*Jm*L^3*M^2*R*bet*n^2*x2*sin(x4) - 4*Jm*L*M^2*R^3*bet*n^2*x5*sin(x4) + 4*Jm*L^3*M^2*R*bet*n^2*x5*sin(x4) + 8*J_psi*Jm*Jw*L*M*g*n^2*cos(x4) - 4*Jm*L*M^2*R^3*fw*n^2*x2*sin(x4) - 4*Jm*L^3*M^2*R*fw*n^2*x2*sin(x4) + 8*J_psi*Jw*L*M*R^2*g*m*cos(x4) - 4*Jm*L^2*M^2*R^4*m*n^2*x5^2*cos(2*x4) + 8*Jm*L^2*M*R^4*m^2*n^2*x8^2*cos(2*x4) + 8*Jm*L^2*M^2*R^4*m*n^2*x8^2*cos(2*x4) + 8*Jm*L^4*M^2*R^2*m*n^2*x8^2*cos(2*x4) + 8*Jm^2*L^2*M*R^2*m*n^4*x8^2*cos(2*x4) + 2*Jm*L^3*M^2*R^3*m*n^2*x8^2*cos(3*x4) + 4*J_psi*Jm*L*M*R^3*m*n^2*x5^2*cos(x4) + 2*J_psi*Jm*L*M*R*anp*n^2*vl*sin(x4) + 2*J_psi*Jm*L*M*R*anp*n^2*vr*sin(x4) - 4*Jm*Jw*L*M*R*anp*n^2*vl*sin(x4) - 4*Jm*Jw*L*M*R*anp*n^2*vr*sin(x4) - 4*J_psi*Jm*L*M*R*bet*n^2*x2*sin(x4) + 4*J_psi*Jm*L*M*R*bet*n^2*x5*sin(x4) + 8*Jm*Jw*L*M*R*bet*n^2*x2*sin(x4) - 8*Jm*Jw*L*M*R*bet*n^2*x5*sin(x4) - 4*J_psi*Jm*L*M*R*fw*n^2*x2*sin(x4) - 8*Jm*Jw*L*M*R*fw*n^2*x2*sin(x4) + 4*J_psi*Jm*Jw*L*M*R*n^2*x5^2*cos(x4) + 8*J_psi*Jm*L*M*R^2*g*m*n^2*cos(x4) + 16*Jm*Jw*L*M*R^2*g*m*n^2*cos(x4) + 8*J_psi*Jm*L^2*M*R^2*m*n^2*x8^2*cos(2*x4) + 16*Jm*Jw*L^2*M*R^2*m*n^2*x8^2*cos(2*x4) - 4*Jm*L*M*R^3*anp*m*n^2*vl*sin(x4) - 4*Jm*L*M*R^3*anp*m*n^2*vr*sin(x4) + 8*Jm*L*M*R^3*bet*m*n^2*x2*sin(x4) - 8*Jm*L*M*R^3*bet*m*n^2*x5*sin(x4) - 8*Jm*L*M*R^3*fw*m*n^2*x2*sin(x4))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4))^2,  -(2*(x5*cos(x4)*sin(x4)*L^2*M^2*R^2 - 2*Jm*x5*sin(x4)*L*M*R*n^2 + bet*cos(x4)*L*M*R + bet*M*R^2 + 2*bet*m*R^2 + 2*Jw*bet))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)), 0, (L^2*M*x8*sin(2*x4)*(2*Jw + M*R^2 + 2*Jm*n^2 + 2*R^2*m))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
 0,                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                    0, 0,                                                                                                                                                                                                                                                                                 1;
 0,                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -(2*L^2*M*R^2*(R*W*anp*vr*sin(2*x4) - R*W*anp*vl*sin(2*x4) + 4*J_phi*R^2*x5*x8*cos(2*x4) + 2*Jw*W^2*x5*x8*cos(2*x4) - R^4*W^2*bet*x8*sin(2*x4) - R^4*W^2*fw*x8*sin(2*x4) - 2*L^2*M*R^2*x5*x8 + 2*L^2*M*R^2*x5*x8*cos(2*x4) + 2*Jm*W^2*n^2*x5*x8*cos(2*x4) + 2*R^2*W^2*m*x5*x8*cos(2*x4)))/(2*J_phi*R^2 + Jw*W^2 + L^2*M*R^2 + Jm*W^2*n^2 + R^2*W^2*m - L^2*M*R^2*cos(2*x4))^2,                                                                                                                                                                                                                                            -(4*L^2*M*R^2*x8*cos(x4)*sin(x4))/(2*J_phi*R^2 + Jw*W^2 + Jm*W^2*n^2 + R^2*W^2*m + 2*L^2*M*R^2*sin(x4)^2), 0,                                                                                                                                          -(R^4*W^2*bet + R^4*W^2*fw + 2*L^2*M*R^2*x5*sin(2*x4))/(2*J_phi*R^2 + Jw*W^2 + L^2*M*R^2 + Jm*W^2*n^2 + R^2*W^2*m - L^2*M*R^2*cos(2*x4))];

AAA = simplify(expand(A1));
B1=...
[                                                                                                                                                                                                                                                                       0,                                                                                                                                                                                                                                                                        0;
           (anp*(M*L^2 + M*R*cos(x4)*L + J_psi))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)),           (anp*(M*L^2 + M*R*cos(x4)*L + J_psi))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
                                                                                                                                                                                                                                                                        0,                                                                                                                                                                                                                                                                        0;
 -(anp*(2*Jw + M*R^2 + 2*R^2*m + L*M*R*cos(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4)), -(anp*(2*Jw + M*R^2 + 2*R^2*m + L*M*R*cos(x4)))/(2*J_psi*Jw + L^2*M^2*R^2 + 2*Jw*L^2*M + J_psi*M*R^2 + 2*J_psi*Jm*n^2 + 4*Jm*Jw*n^2 + 2*J_psi*R^2*m + 2*Jm*L^2*M*n^2 + 2*Jm*M*R^2*n^2 + 2*L^2*M*R^2*m + 4*Jm*R^2*m*n^2 - L^2*M^2*R^2*cos(x4)^2 + 4*Jm*L*M*R*n^2*cos(x4));
                                                                                                                                                                                                                                                                        0,                                                                                                                                                                                                                                                                        0;
                                                                                                                                                                                       -(R*W*anp)/(2*J_phi*R^2 + Jw*W^2 + Jm*W^2*n^2 + R^2*W^2*m + 2*L^2*M*R^2*sin(x4)^2),                                                                                                                                                                                        (R*W*anp)/(2*J_phi*R^2 + Jw*W^2 + Jm*W^2*n^2 + R^2*W^2*m + 2*L^2*M*R^2*sin(x4)^2)];                                                                                                                                                                                                                                                                    
BBB = simplify(expand(B1));